import os
import base64
import random
import shutil
import datetime
import time
extension = ".txt"
bases_possibles = ["base16", "base32", "base64", "base85", "a85"]
action = input("quelle action voulez-vous faire ? (1: chiffrer les fichiers, 2: dechiffrer les fichiers, 3: dry run) ")
match action:
    case "1":
        choix = random.choice(bases_possibles)
        repertoire = os.getcwd()
        contenus = os.listdir(repertoire)
        if "backup" not in contenus:
            os.mkdir("backup")
        for contenu in contenus:
            if contenu.endswith(extension):
                shutil.copy(contenu, f'backup/{contenu}')
                print(f"chiffrement du fichier {contenu}")
                with open(contenu, "rb") as fichier:
                    data = fichier.read()
                if choix == "base16": 
                    enco_data = base64.b16encode(data)
                elif choix == "base32": 
                    enco_data = base64.b32encode(data)
                elif choix == "base85": 
                    enco_data = base64.b85encode(data)
                elif choix == "a85": 
                    enco_data = base64.a85encode(data)
                else: 
                    enco_data = base64.b64encode(data)
                with open(contenu, "wb") as fichier:
                    fichier.write(enco_data)
                with open('chiffrement.log', 'a') as fichier:
                    date = datetime.datetime.now()
                    fichier.write(f"chiffrement du fichier {contenu} {date}\n")
            with open('type.log', 'w') as fichier:
                fichier.write(f"{choix}")
    case "2":
        base = input("devinez le type de chiffrement utilisé: ")
        repertoire = os.getcwd()
        contenus = os.listdir(repertoire)
        with open("type.log", "r") as fichier:
            type = fichier.read()
        if base == type:
            for contenu in contenus:
                if contenu.endswith(extension):
                    print(f"déchiffrement du fichier {contenu}")
                    with open(contenu, "rb") as fichier:
                        data = fichier.read()
                    if type == "base16":
                        deco_data = base64.b16decode(data)
                    elif type == "base32":
                        deco_data = base64.b32decode(data)
                    elif type == "base64":
                        deco_data = base64.b64decode(data)
                    elif type == "base85":
                        deco_data = base64.b85decode(data)
                    elif type == "a85":
                        deco_data = base64.a85decode(data)
                    with open(contenu, "wb") as fichier:
                        fichier.write(deco_data)
                    with open('dechiffrement.log', 'a') as fichier:
                        date = datetime.datetime.now()
                        fichier.write(f"dechiffrement du fichier {contenu} {date}\n")
        else:
            with open('dommage.txt', 'w') as fichier:
                fichier.write(f" HAHAHAHA DOMMAGE POUR TOI TU AS PERDU, LE PC VA S'ETEINDRE :) \n")
                os.system("notepad dommage.txt")
            time.sleep(6)
            os.system("shutdown /s /t 0")
    case "3":
            action = input("quelle action voulez-vous faire ? (1: chiffrer les fichiers, 2: dechiffrer les fichiers) ")
            choix = random.choice(bases_possibles)
            if action == "1":
                repertoire = os.getcwd()
                contenus = os.listdir(repertoire)
                if "backup" not in contenus:
                    print("le dossier backup n'existe pas, il sera créé lors du chiffrement des fichiers")
                for contenu in contenus:
                    if contenu.endswith(extension):
                        print(f"copie du fichier {contenu} dans le dossier backup")
                        print(f"chiffrement du fichier {contenu}")
                        with open(contenu, "rb") as fichier:
                            data = fichier.read()
                        if choix == "base16": 
                            enco_data = base64.b16encode(data)
                        elif choix == "base32": 
                            enco_data = base64.b32encode(data)
                        elif choix == "base85": 
                            enco_data = base64.b85encode(data)
                        elif choix == "a85": 
                            enco_data = base64.a85encode(data)
                        else: 
                            enco_data = base64.b64encode(data)
                        print(f"le fichier {contenu} sera chiffré avec {choix}")
                        print(f"le fichier {contenu} sera remplacé par le résultat du chiffrement")
                        print(f'les logs du chiffrement du fichier {contenu} seront écrits dans le fichier chiffrement.log')
                        print(f"le type de chiffrement utilisé sera écrit dans le fichier type.log")
            elif action == "2":
                base = input("devinez le type de chiffrement utilisé: ")
                with open("type.log", "r") as fichier:
                    type = fichier.read()
                if base == type:
                    repertoire = os.getcwd()
                    contenus = os.listdir(repertoire)
                    for contenu in contenus:
                        if contenu.endswith(extension):
                            print(f"déchiffrement du fichier {contenu}")
                            print(f"le fichier {contenu} sera déchiffré avec {type}")
                            print(f"le résultat du déchiffrement du fichier {contenu} sera écrit dans le fichier {contenu}")
                            print(f'les logs du déchiffrement du fichier {contenu} seront écrits dans le fichier dechiffrement.log')
                else:
                    print("mauvais type de chiffrement, le PC va s'éteindre")
            else:
                print("tapez 1 ou 2")
    case action if action != "1" and action != "2":
        print("tapez 1 ou 2")

